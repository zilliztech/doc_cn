---
id: "megawise_sql_syntax"
lang: "cn"
title: "SQL 语法"
---
# SQL 语法

本部分描述了 MegaWise 中支持的 SQL 的语法以及 MegaWise 中特有的规则和概念。

<!-- TOC -->

- [词法结构](#词法结构)
    - [标识符和关键词](#标识符和关键词)
    - [常量](#常量)
        - [字符串常量](#字符串常量)
        - [C 风格转义的字符串常量](#C-风格转义的字符串常量)
        - [美元引用的字符串常量](#美元引用的字符串常量)
        - [位串常量](#位串常量)
        - [数字常量](#数字常量)
    - [特殊字符](#特殊字符)
    - [注释](#注释)
    - [操作符优先级](#操作符优先级)
- [值表达式](#值表达式)
    - [列引用](#列引用)
    - [位置参数](#位置参数)
    - [操作符调用](#操作符调用)
    - [函数调用](#函数调用)
    - [类型转换](#类型转换)
    - [标量子查询](#标量子查询)

<!-- /TOC -->

## 词法结构

SQL 输入由命令的序列组成。一个命令由一个记号的序列构成，并由一个分号 `;` 终结。输入流的末端也会标志一个命令的结束。

一个记号可以是一个关键词、一个标识符、一个带引号的标识符、一个常量或者一个特殊字符。记号通常以空白（空格、制表符、新行）来分隔，但是特殊字符必须紧挨其他记号。

如下是一个合法的 SQL 输入：

```sql
SELECT * FROM MY_TABLE;
INSERT INTO MY_TABLE VALUES (3, 'hi there');
```

这是一个由两个命令组成的序列，每一行一个命令（在 MegaWise 中这不是必须的，在同一行中可以有超过一个命令，而且命令还可以被跨行分割）。

### 标识符和关键词

上例中的 `SELECT` 或 `VALUES` 记号是 SQL 语句中的关键词，即 SQL 语言中具有特定意义的词。记号 `MY_TABLE` 是语句中的标识符。系统中一个标识符的长度不能超过 63 字节。

SQL 标识符和关键词必须以一个字母（`a`-`z`，也可以是带变音符的字母和非拉丁字母）或一个下划线 `_` 开始。后续字符可以是字母、下划线 `_` 、数字 `0` - `9` 或美元符号 `$` 。注意根据 SQL 标准的字母规定，美元符号是不允许出现在标识符中的。SQL 标准不会定义包含数字或者以下划线开头或结尾的关键词。

关键词和不被引号修饰的标识符是大小写不敏感的。因此：

```sql
INSERT INTO MY_TABLE VALUES (3, 'hi there');
```

可以等价地写成：

```sql
INSERT INTO MY_TABLE VaLuEs (3, 'hi there');
```

一个常见的习惯是将关键词写成大写，而名称写成小写，例如：

```sql
iNSeRT iNTo my_table VALUES (3, 'hi there');
```

这里还有第二种形式的标识符：受限标识符或被引号修饰的标识符。它是由双引号 `"` 包围的一个任意字符序列。一个受限标识符总是一个标识符而不会是一个关键字。因此 `"select"` 可以用于引用一个名为 “select” 的列或者表，而一个没有引号修饰的 `select` 则会被当作一个关键词，从而在本应使用表或列名的地方引起解析错误。在上例中使用受限标识符的例子如下：

```sql
INSERT INTO "my_table" VALUES (3, 'hi there');
```

受限标识符可以包含任何字符。一种受限标识符的变体允许包括转义的 Unicode 字符。这种变体以 `U&` 开始，后面紧跟双引号修饰的名称，两者之间没有任何空白，如 `U&"foo"`（注意这里与操作符 `&` 似乎有一些混淆，但是在 `&` 操作符周围使用空白避免了这个问题） 。在引号内，Unicode 字符可以以转义的形式指定：反斜线接上 4 位 16 进制代码点号码或者反斜线和加号接上6位16进制代码点号码。例如，标识符 `"data"` 可以写成：

```sql
U&"d\0061t\+000061"
```

下面的例子用西里尔字母写出了俄语单词 “slon”（大象）：

```sql
U&"\0441\043B\043E\043D"
```

如果希望使用其他转义字符来代替反斜线，可以在字符串后使用 `UESCAPE` 子句，例如：

```sql
U&"d!0061t!+000061" UESCAPE '!'
```

转义字符可以是除了16进制位、加号、单引号、双引号、空白字符之外的任意单个字符。注意转义字符是被写在单引号而不是双引号内。

为了在标识符中包括转义字符本身，将其写两次即可。

Unicode 转义语法只有在编码为 `UTF8` 时才起效。当使用其他编码时，只有在 ASCII 范围内（最高到 `\007F` ）的编码点才能被使用。

受限标识符是大小写敏感的，而非受限标识符总是被转换成小写形式。例如，标识符 `FOO`、`foo` 和 `"foo"` 在 MegaWise 中被认为是相同的，而 `"Foo"` 和 `"FOO"` 则互不相同且也不同于前面三个标识符（ MegaWise 将非受限名字转换为小写形式与SQL 标准是不兼容的， SQL 标准中要求将非受限名称转换为大写形式。这样根据标准， `foo` 应该和 `"FOO"` 而不是 `"foo"` 相同。如果希望写一个可移植的应用，我们应该总是用引号修饰一个特定名字或者从不使用引号修饰）。

### 常量

在 MegaWise 中有三种隐式类型常量：字符串、位串和数字。常量也可以被指定显示类型，这可以使得它被更精确地展示以及更有效地处理。这些选择将会在后续小节中讨论。

#### 字符串常量

在 SQL 中，一个字符串常量是一个由单引号 `'` 包围的任意字符序列，例如 `'This is a string'`。为了在一个字符串中包括一个单引号，可以写两个相连的单引号，例如 `'Dianne''s horse'` 。注意这和一个双引号 `"` 不同。

两个被换行符所分隔的字符串常量会被连接在一起，并且将作为一个写在一起的字符串常量来对待。例如：

```sql
SELECT 'foo'
'bar';
```

等同于：

```sql
SELECT 'foobar';
```

但是：

```sql
SELECT 'foo'      'bar';
```

则不合法（这种语法上的合法性是 SQL 指定的，MegaWise 遵循了该标准）。

#### C 风格转义的字符串常量

MegaWise 也接受“转义”字符串常量，这也是 SQL 标准的一个扩展。一个转义字符串常量可以通过在单引号前面写一个字母 E（大写或小写形式）来指定，例如 E'foo'（当一个转义字符串常量跨行时，只在第一个开引号之前写 E）。在一个转义字符串内部，一个反斜线字符（\）会开始一个 C 风格的反斜线转义序列，在其中反斜线和后续字符的组合表示一个特殊的字节值（如下表中所示）。

**反斜线转义序列**

| 反斜线转义序列                                  | 解释                               |
| ----------------------------------------------- | ---------------------------------- |
| `\b`                                            | 退格                               |
| `\f`                                            | 换页                               |
| `\n`                                            | 换行                               |
| `\r`                                            | 回车                               |
| `\t`                                            | 制表符                             |
| `\*o*`, `\*oo*`, `\*ooo*` (*o* = 0 - 7)         | 八进制字节值                       |
| `\x*h*`, `\x*hh*` (*h* = 0 - 9, A - F)          | 十六进制字节值                     |
| `\u*xxxx*`, `\U*xxxxxxxx*` (*x* = 0 - 9, A - F) | 16 或 32-位十六进制 Unicode 字符值 |


跟随在一个反斜线后面的任何其他字符被当做其字面意思。因此，要包括一个反斜线字符，请写两个反斜线 `\\` 。在一个转义字符串中包括一个单引号除了普通方法 `''` 之外，还可以写成 `\'` 。

字节序列必须由字符集编码中合法的字符组成，特别是在使用八进制或十六进制转义时。如果编码为 UTF-8，那么应该使用 Unicode 转义或替代的 Unicode 转义语法（参考第 2.1.1 节）。你也可以手动写出 UTF-8 编码字节，但会非常麻烦。

#### 美元引用的字符串常量

虽然用于指定字符串常量的标准语法通常都很方便，但是当字符串中包含了很多单引号或反斜线时会很难理解，因为每一个都需要被双写。为了提升可读性，MegaWise 提供了另一种被称为“美元引用”的方式来书写字符串常量。一个美元引用的字符串常量由一个美元符号 `$` 、一个可选的另个或更多字符的“标签”、另一个美元符号、一个构成字符串内容的任意字符序列、一个美元符号、开始这个美元引用的相同标签和一个美元符号组成。例如，这里有两种不同的方法使用美元引用指定字符串 “Dianne's horse” ：

```sql
$$Dianne's horse$$
$SomeTag$Dianne's horse$SomeTag$
```

注意在美元引用字符串中，单引号可以在不被转义的情况下使用。事实上，在一个美元引用字符串中不需要对字符进行转义：字符串内容总是按其字面意思写出。反斜线不是特殊的，并且美元符号也不是特殊的，除非它们是匹配开标签的一个序列的一部分。

可以通过在每一个嵌套级别上选择不同的标签来嵌套美元引用字符串常量。这最常被用在编写函数定义上。例如：

```sql
$function$
BEGIN
    RETURN ($1 ~ $q$[\t\r\n\v\\]$q$);
END;
$function$
```

这里，序列 `$q$[\t\r\n\v\\]$q$` 表示一个美元引用的文字串`[\t\r\n\v\\]`，当该函数体被 MegaWise 执行时该序列将被识别。但是因为该序列不匹配外层的美元引用的定界符 `$function$` ，它只是一些在外层字符串所关注的常量中的字符而已。

一个美元引用字符串的标签（如果有）遵循一个未被引用标识符的相同规则，除了它不能包含一个美元符号之外。标签是大小写敏感的，因此 `$tag$String content$tag$` 是正确的，但是 `$TAG$String content$tag$` 不正确。

一个跟着关键词或标识符的美元引用字符串必须用空白与之分隔开，否则美元引用定界符可能会被作为前面标识符的一部分。

美元引用不是 SQL 标准的一部分，但是在书写复杂字符串文字方面，它常常是一种比兼容标准的单引号语法更方便的方法。当要表示的字符串常量位于其他常量中时它特别有用，这种情况常常在过程函数定义中出现。如果用单引号语法，上一个例子中的每个反斜线将必须被写成四个反斜线，这在解析原始字符串常量时会被缩减到两个反斜线，并且接着在函数执行期间重新解析内层字符串常量时变成一个。

#### 位串常量

以二进制表示的位串常量以 `B`（大写或小写形式）为前导，例如 `B'1001'` 。位串常量中允许的字符只有 `0` 和 `1` 。

位串常量也可以用十六进制记号法指定，使用一个前导 `X`（大写或小写形式）,例如 `X'1FF'`。

两种形式的位串常量可以以常规字符串常量相同的方式进行跨行。美元引用不能被用在位串常量中。

#### 数字常量

数字常量通常以如下形式描述：

```sql
digits
digits.[digits][e[+-]digits]
[digits].digits[e[+-]digits]
digitse[+-]digits
```

其中*digits*是一个或多个十进制数字（0 到 9）。如果使用了小数点，在小数点前面或后面必须至少有一个数字。如果存在一个指数标记 `e` ，在其后必须跟着至少一个数字。在该常量中不能嵌入任何空白或其他字符。注意任何前导的加号或减号并不实际被考虑为常量的一部分，它是一个应用到该常量的操作符。

这里给出一些合法数字常量的例子：

42
3.5
4.
.001
5e2
1.925e-3

对于一个不包含小数点和指数的数字常量，MegaWise 会根据其值的大小为其指定类型，如`integer`（32 位）、`bigint`（64 位）、`numeric`。包含小数点和/或指数的常量总是首先被假定为类型`numeric`。、

你也可以为常量强制指定数据类型。例如，你可以这样强制一个数字值被当做类型`real`（`float4`）：

```sql
REAL '1.23'  -- string style
1.23::REAL   -- MegaWise (historical) style
```

### 特殊字符

- 跟随在一个美元符号 `$` 后面的数字被用来表示在一个函数定义或一个预备语句中的位置参数。在其他上下文中该美元符号可以作为一个标识符或者一个美元引用字符串常量的一部分。
- 圆括号 `()` 具有它们通常的含义，用来分组表达式并且强制优先。在某些情况中，圆括号被要求作为一个特定 SQL 命令的固定语法的一部分。
- 逗号 `,` 被用在某些语法结构中来分割一个列表的元素。
- 分号 `;` 结束一个 SQL 命令。它不能出现在一个命令中间的任何位置，除了在一个字符串常量中或者一个被引用的标识符中。
- 星号 `*` 被用在某些上下文中标记一个表的所有域或者组合值。当它被用作一个聚合函数的参数时，它还有一种特殊的含义，即该聚合不要求任何显式参数。
- 句点 `.` 被用在数字常量中，并且被用来分割模式、表和列名。

### 注释

一段注释是以双斜线开始并且延伸到行结尾的一个字符序列，例如：

```sql
-- This is a standard SQL comment
```

另外，也可以使用 C 风格注释块：

```sql
/* multiline comment
 * with nesting: /* nested block comment */
 */
```

这里该注释开始于`/*`并且延伸到匹配出现的`*/`。这些注释块可按照 SQL 标准中指定的方式嵌套，但和 C 中不同。这样我们可以注释掉一大段可能包含注释块的代码。

### 操作符优先级

大部分操作符具有相同的优先并且是左结合的。 

当使用二元和一元操作符的组合时，有时你将需要增加圆括号。例如：

```sql
SELECT 5 ! - 6;
```

将被解析为：

```sql
SELECT 5 ! (- 6);
```

为了使 MegaWise 执行期望的操作，必须写成如下形式：

```sql
SELECT (5 !) - 6;
```
下表展示了 MegaWise 中操作符的优先级和结合性。

**操作符优先级（最高到最低）**

| 操作符/元素                              | 结合性 | 描述                           |
| ---------------------------------------- | ------ | ------------------------------ |
| `.`                                      | 左     | 表/列名分隔符                  |
| `::`                                     | 左     | 类型转换         |
| `+` `-`                                  | 右     | 一元加、一元减                 |
| `^`                                      | 左     | 指数                           |
| `*` `/` `%`                              | 左     | 乘、除、模                     |
| `+` `-`                                  | 左     | 加、减                         |
| `BETWEEN` `IN` `LIKE` `ILIKE`            |        | 范围包含，设置成员，字符串匹配 |
| `<` `>` `=` `<origin/develop=` `>=` `<>` |        | 比较操作符                     |
| `NOT`                                    | 右     | 逻辑否定                       |
| `AND`                                    | 左     | 逻辑合取                       |
| `OR`                                     | 左     | 逻辑析取                       |


## 值表达式

在 SQL 语法中，值表达式可能出现在多种命令中。例如在 `SELECT` 命令的目标列表中、作为 `INSERT` 中的新列值或者若干命令中的搜索条件。表达式语法允许使用算数、逻辑、集合和其他操作从原始部分计算值。

一个值表达式是下列之一：

- 常量或文字值
- 列引用
- 在函数定义体或预备语句中的位置参数引用
- 操作符调用
- 函数调用
- 类型转换
- 标量子查询

### 列引用

一个列可以通过如下形式被引用：

```sql
correlation.columnname
```

*correlation* 是一个表的名字或者是在 `FROM` 子句中为一个表定义的别名。如果列名在当前索引所使用的表中都是唯一的，关联名称和分隔用的句点可以被忽略。

### 位置参数

位置参数引用用于指示一个由 SQL 语句外部提供的值。参数被用于 SQL 函数定义和预备查询中。一个参数引用的形式是：

```sql
$number
```

例如，考虑一个函数 `dept` 的定义：

```sql
CREATE FUNCTION dept(text) RETURNS dept
    AS $$ SELECT * FROM dept WHERE name = $1 $$
    LANGUAGE SQL;
```

其中 `$1` 引用的是函数被调用时第一个函数参数的值。

### 操作符调用

对于一次操作符调用，有三种可能的语法：

 *expression* *operator* *expression*（二元中缀操作符） 
 *operator* *expression*（一元前缀操作符）              
 *expression* *operator*（一元后缀操作符）              

其中 operator 记号遵循 operator 的语法规则，或者是关键词 `AND` 、`OR` 和 `NOT` 之一，或者是一个如下形式的受限定操作符名：

```sql
OPERATOR(schema.operatorname)
```

### 函数调用

一个函数调用的语法是一个函数的名称以及其后使用圆括号封闭的参数列表：

```sql
function_name ([expression [, expression ... ]] )
```

例如，平方根函数：

```sql
sqrt(2)
```

### 类型转换

类型转换用于表示将数据从一种数据类型转换到另一种数据类型。MegaWise 接受两种等价的类型转换语法：

```sql
CAST ( expression AS type )
expression::type

```

`CAST` 遵从 SQL 语法，而`::`是 MegaWise 的特殊语法。

当强制转换应用于已知类型的值表达式时，它表示运行时类型转换。如果一个值表达式所产生的类型没有歧义（例如当它被指派给一个表列），通常可以省略显式类型转换，在这种情况下系统会自动应用一个类型转换。


### 标量子查询

一个标量子查询是一种圆括号内的普通 `SELECT` 查询，它刚好返回一行一列。将一个返回超过一行或一列的查询作为一个标量子查询使用是一种错误。如果在一次特定执行期间该子查询没有返回行则不是错误，该标量结果被当做为空。该子查询可以从周围的查询中引用变量，这些变量在该子查询的计算中都作为常量。

例如，下列语句会寻找每个州城市人口的最大值：

```sql
SELECT name, (SELECT max(pop) FROM cities WHERE cities.state = states.name)
    FROM states;
```









